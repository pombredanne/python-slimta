

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Relay Services &mdash; slimta 0.3.8 documentation</title>
    
    <link rel="stylesheet" href="../_static/cloud.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Noticia+Text|Open+Sans|Droid+Sans+Mono" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.3.8',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/jquery.cookie.js"></script>
    <script type="text/javascript" src="../_static/cloud.js"></script>
    <link rel="top" title="slimta 0.3.8 documentation" href="../index.html" />
    <link rel="up" title="Usage Manual" href="../manual.html" />
    <link rel="next" title="Policy Implementation" href="policies.html" />
    <link rel="prev" title="Queue Services" href="queue.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
    <div class="relbar-top">
        
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="policies.html" title="Policy Implementation"
             accesskey="N">next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="queue.html" title="Queue Services"
             accesskey="P">previous</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">slimta 0.3.8 documentation</a> &raquo;</li>

          <li><a href="../manual.html" accesskey="U">Usage Manual</a> &raquo;</li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="relay-services">
<h1>Relay Services<a class="headerlink" href="#relay-services" title="Permalink to this headline">¶</a></h1>
<p>Relay services are given an existing message and attempt to delivery it to the
message&#8217;s next destination. In a traditional MTA, this next destination will be
looked up by the recipient&#8217;s domain MX record and delivery is done with SMTP.
In other cases, such as when acting as an <em>MDA</em>, <a class="reference external" href="http://slimta.org/">slimta</a> is the final
destination and delivery occurs locally with something like <a class="reference external" href="http://www.courier-mta.org/maildrop/">courier-maildrop</a>.</p>
<p>In any case, the relay will report either its attempt was a success or whether
failure was permanent or transient.</p>
<div class="section" id="smtp-smart-host-relaying">
<span id="relay-smtp-smarthost"></span><h2>SMTP Smart-Host Relaying<a class="headerlink" href="#smtp-smart-host-relaying" title="Permalink to this headline">¶</a></h2>
<p>A very common type of relaying is sending all mail through to a single
destination. This could be a local mail server that delivers all mail to its
ISP mail servers, or it could be useful for a &#8220;front-line&#8221; of email servers
whose sole purpose is spam scanning before handing off for real processing and
routing. This static delivery is generally called <a class="reference external" href="http://en.wikipedia.org/wiki/Smart_host">Smart-Hosting</a></p>
<p>Smart-Host relaying can be done with the
<a class="reference internal" href="../api/slimta.relay.smtp.static.html#slimta.relay.smtp.static.StaticSmtpRelay" title="slimta.relay.smtp.static.StaticSmtpRelay"><tt class="xref py py-class docutils literal"><span class="pre">StaticSmtpRelay</span></tt></a> class, which will maintain
a pool of connections to the destination that will be re-used if idle. For
example, to ensure no more than one open connection to a destination is open at
once:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">slimta.relay.smtp.static</span> <span class="kn">import</span> <span class="n">StaticSmtpRelay</span>
<span class="n">relay</span> <span class="o">=</span> <span class="n">StaticSmtpRelay</span><span class="p">(</span><span class="s">&#39;smarthost.example.com&#39;</span><span class="p">,</span> <span class="n">pool_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="smtp-mx-relaying">
<span id="relay-smtp-mx"></span><h2>SMTP MX Relaying<a class="headerlink" href="#smtp-mx-relaying" title="Permalink to this headline">¶</a></h2>
<p>Email messages destined for a recipient address hosted elsewhere on the
Internet are relayed by querying the recipient domain&#8217;s MX records. The result
is a prioritized list of hostnames that should be considered the next hop for
the message. The highest priority (given by the lowest MX preference number)
hostname is tried first, and lower priority hostnames should be tried
subsequently. MX relaying always uses port 25.</p>
<p>MX relaying can be done with the <a class="reference internal" href="../api/slimta.relay.smtp.mx.html#slimta.relay.smtp.mx.MxSmtpRelay" title="slimta.relay.smtp.mx.MxSmtpRelay"><tt class="xref py py-class docutils literal"><span class="pre">MxSmtpRelay</span></tt></a>
class, which will automatically cache MX records until their TTL and will
keep a <a class="reference internal" href="../api/slimta.relay.smtp.static.html#slimta.relay.smtp.static.StaticSmtpRelay" title="slimta.relay.smtp.static.StaticSmtpRelay"><tt class="xref py py-class docutils literal"><span class="pre">StaticSmtpRelay</span></tt></a> object for each
destination, so that connections are re-used:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">slimta.relay.smtp.mx</span> <span class="kn">import</span> <span class="n">MxSmtpRelay</span>
<span class="n">relay</span> <span class="o">=</span> <span class="n">MxSmtpRelay</span><span class="p">()</span>
</pre></div>
</div>
<p>Recipient domains can be configured to ignore MX records and permanently
deliver to a certain hostname using the
<a class="reference internal" href="../api/slimta.relay.smtp.mx.html#slimta.relay.smtp.mx.MxSmtpRelay.force_mx" title="slimta.relay.smtp.mx.MxSmtpRelay.force_mx"><tt class="xref py py-meth docutils literal"><span class="pre">force_mx()</span></tt></a> method:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">relay</span><span class="o">.</span><span class="n">force_mx</span><span class="p">(</span><span class="s">&#39;example.com&#39;</span><span class="p">,</span> <span class="s">&#39;smarthost.example.com&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="http-relaying">
<span id="relay-http"></span><h2>HTTP Relaying<a class="headerlink" href="#http-relaying" title="Permalink to this headline">¶</a></h2>
<p>Similar to the <a class="reference internal" href="edge.html#edge-http"><em>HTTP Edge</em></a>, HTTP can be used to relay messages
as the data payload of a request. The EHLO, sender, and recipients information
usually transferred in the SMTP request are sent as headers in the request.
Refer to the <a class="reference internal" href="../api/slimta.relay.http.html#module-slimta.relay.http" title="slimta.relay.http"><tt class="xref py py-mod docutils literal"><span class="pre">slimta.relay.http</span></tt></a> module for more information on how this
request is constructed.</p>
<p>If the remote host is an <a class="reference internal" href="edge.html#edge-http"><em>HTTP Edge</em></a>, the response to the
request will most likely have an <tt class="docutils literal"><span class="pre">X-Smtp-Reply</span></tt> header that is used as the
message delivery <a class="reference internal" href="../api/slimta.smtp.reply.html#slimta.smtp.reply.Reply" title="slimta.smtp.reply.Reply"><tt class="xref py py-class docutils literal"><span class="pre">Reply</span></tt></a> when returning to the queue. If the response does not
have this header, then <a class="reference internal" href="../api/slimta.relay.html#slimta.relay.PermanentRelayError" title="slimta.relay.PermanentRelayError"><tt class="xref py py-class docutils literal"><span class="pre">PermanentRelayError</span></tt></a> is raised for
<tt class="docutils literal"><span class="pre">4XX</span></tt> codes and <a class="reference internal" href="../api/slimta.relay.html#slimta.relay.TransientRelayError" title="slimta.relay.TransientRelayError"><tt class="xref py py-class docutils literal"><span class="pre">TransientRelayError</span></tt></a> is raised for
<tt class="docutils literal"><span class="pre">5XX</span></tt> codes.</p>
<p>HTTP relays are set up by creating a <a class="reference internal" href="../api/slimta.relay.http.html#slimta.relay.http.HttpRelay" title="slimta.relay.http.HttpRelay"><tt class="xref py py-class docutils literal"><span class="pre">HttpRelay</span></tt></a>
object:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">slimta.relay.http</span> <span class="kn">import</span> <span class="n">HttpRelay</span>
<span class="n">relay</span> <span class="o">=</span> <span class="n">HttpRelay</span><span class="p">(</span><span class="s">&#39;http://example.com:8025/messages/&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="external-process-relaying">
<span id="relay-maildrop"></span><h2>External Process Relaying<a class="headerlink" href="#external-process-relaying" title="Permalink to this headline">¶</a></h2>
<p>When <a class="reference external" href="http://slimta.org/">slimta</a> is configured to be the final destination for the email message,
it can stream a message to an external process to locally deliver the message.
This is how applications like <a class="reference external" href="http://www.courier-mta.org/maildrop/">courier-maildrop</a> and <a class="reference external" href="http://wiki.dovecot.org/LDA">dovecot-lda</a> are given
messages. This method is modeled off the <a class="reference external" href="http://www.postfix.org/pipe.8.html">pipe daemon</a> from postfix.  This
type of relay is provided in the <a class="reference internal" href="../api/extra.piperelay.html#module-slimta.piperelay" title="slimta.piperelay"><tt class="xref py py-mod docutils literal"><span class="pre">slimta.piperelay</span></tt></a> module. Here&#8217;s an
example of delivery to the <tt class="docutils literal"><span class="pre">maildrop</span></tt> command:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">slimta.piperelay</span> <span class="kn">import</span> <span class="n">MaildropRelay</span>
<span class="n">relay</span> <span class="o">=</span> <span class="n">MaildropRelay</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="../api/extra.piperelay.html#module-slimta.piperelay" title="slimta.piperelay"><tt class="xref py py-mod docutils literal"><span class="pre">slimta.piperelay</span></tt></a> module is packaged separately as an extension as
described in <a class="reference internal" href="extensions.html#pipe-relay"><em>External Process Delivery</em></a>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
        <p class="logo"><a href="../index.html">
          <img class="logo" src="../_static/slimta.svg" alt="Logo"/>
        </a></p>
  <div class="sphinxlocaltoc">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Relay Services</a><ul>
<li><a class="reference internal" href="#smtp-smart-host-relaying">SMTP Smart-Host Relaying</a></li>
<li><a class="reference internal" href="#smtp-mx-relaying">SMTP MX Relaying</a></li>
<li><a class="reference internal" href="#http-relaying">HTTP Relaying</a></li>
<li><a class="reference internal" href="#external-process-relaying">External Process Relaying</a></li>
</ul>
</li>
</ul>

  </div>
  <h4>Previous topic</h4>
  <p class="topless"><a href="queue.html"
                        title="previous chapter">Queue Services</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="policies.html"
                        title="next chapter">Policy Implementation</a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="policies.html" title="Policy Implementation"
             >next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="queue.html" title="Queue Services"
             >previous</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">slimta 0.3.8 documentation</a> &raquo;</li>

          <li><a href="../manual.html" >Usage Manual</a> &raquo;</li> 
      </ul>
    </div>
    </div>

    <div class="footer">
        &copy; Copyright 2013, Ian Good.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>